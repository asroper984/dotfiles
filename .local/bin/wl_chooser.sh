#!/bin/bash

# --- CONFIGURATION ---
CONTRAST_RATIO=3           # Text vs Background (Standard)
WAYBAR_CONTRAST_RATIO=7.0    # Focused/Urgent vs Background (High Contrast)
WALLPAPER_DIR="$HOME/.local/share/wallpapers"
SWAY_CONFIG="$HOME/.config/sway/config"

# Paths
WAYBAR_CACHE_FILE="$HOME/.cache/wal/colors-waybar.css"
SWAYNC_CACHE_FILE="$HOME/.cache/wal/colors-swaync.css"

# Fuzzel Configuration Files
FUZZEL_CONFIG="$HOME/.config/fuzzel/fuzzel.ini"
FUZZEL_THEME="$HOME/.config/fuzzel/fuzzel-theme.ini"
FUZZEL_LIGHT="$HOME/.config/fuzzel/fuzzel-light.ini"
FUZZEL_DARK="$HOME/.config/fuzzel/fuzzel-dark.ini"

# --- 1. SELECT WALLPAPER ---
cd "$WALLPAPER_DIR" || { echo "Error: Wallpaper dir not found"; exit 1; }
export SHELL=/bin/bash 

if [ -n "$1" ]; then
    SELECTED_FILE=$(basename "$1")
else
    SELECTED_FILE=$(find . -maxdepth 1 -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" -o -name "*.webp" \) -printf "%f\n" | sort | \
        fzf --height=80% --layout=reverse --border --prompt="Select Wallpaper > " \
        --preview "chafa -s \${FZF_PREVIEW_COLUMNS}x\${FZF_PREVIEW_LINES} {}" \
        --preview-window=right:60%)
fi

if [ -z "$SELECTED_FILE" ]; then
    echo "No selection made."
    exit 0
fi

FULL_PATH="$WALLPAPER_DIR/$SELECTED_FILE"
echo "Selected: $FULL_PATH"

# --- 2. CLEANUP & PREP ---
rm -rf "$HOME/.cache/wal"
mkdir -p "$HOME/.cache/wal"

# --- 3. FIX FUZZEL CONFIG ---
cat << EOF > "$FUZZEL_CONFIG"
# Auto-generated by wl_chooser
include=$FUZZEL_THEME

[main]
# Add any permanent main settings here if needed
EOF

# --- 4. APPLY WALLPAPER ---
sed -i "s#\(output .* bg \).*\( fill\)#\1$FULL_PATH\2#" "$SWAY_CONFIG"
swaymsg output "*" bg "$FULL_PATH" fill > /dev/null 2>&1

# --- 5. PREPARE PYTHON SCRIPT ---
GEN_SCRIPT=$(mktemp)

cat << 'EOF' > "$GEN_SCRIPT"
import sys
import colorsys
import shutil

# --- HELPERS ---
def hex_to_rgb(h): return tuple(int(h.lstrip('#')[i:i+2], 16) for i in (0, 2, 4))
def to_hex(rgb, a='ff'): return f'{rgb[0]:02x}{rgb[1]:02x}{rgb[2]:02x}{a}'

def get_lum(rgb):
    r, g, b = [x/255.0 for x in rgb]
    r = r/12.92 if r <= 0.04045 else ((r+0.055)/1.055)**2.4
    g = g/12.92 if g <= 0.04045 else ((g+0.055)/1.055)**2.4
    b = b/12.92 if b <= 0.04045 else ((b+0.055)/1.055)**2.4
    return 0.2126*r + 0.7152*g + 0.0722*b

def get_contrast(c1, c2):
    l1 = get_lum(c1)
    l2 = get_lum(c2)
    return (max(l1, l2) + 0.05) / (min(l1, l2) + 0.05)

def desaturate(rgb, factor=0.7):
    r, g, b = [x/255.0 for x in rgb]
    h, s, v = colorsys.rgb_to_hsv(r, g, b)
    s *= factor
    r, g, b = colorsys.hsv_to_rgb(h, s, v)
    return tuple(int(x*255) for x in (r, g, b))

def ensure_contrast(bg, fg, ratio):
    """
    Aggressively adjusts fg color to meet contrast ratio against bg.
    If standard shifting fails, snaps to White or Black.
    """
    if get_contrast(bg, fg) >= ratio: return fg
    
    bg_lum = get_lum(bg)
    is_bg_light = bg_lum > 0.5
    r, g, b = fg
    
    # 1. Try shifting the color
    step = 15
    for _ in range(20): 
        if get_contrast(bg, (r,g,b)) >= ratio: return (r,g,b)
        if is_bg_light:
            # Darken
            r = max(0, r-step); g = max(0, g-step); b = max(0, b-step)
        else:
            # Lighten
            r = min(255, r+step); g = min(255, g+step); b = min(255, b+step)
            
    # 2. If strictly failed, force pure Black or White
    if is_bg_light:
        return (0, 0, 0) # Black
    else:
        return (255, 255, 255) # White

try:
    # --- INPUTS ---
    target_ratio = float(sys.argv[1])
    is_light_bg = bool(int(sys.argv[2]))
    path_f_light = sys.argv[3]
    path_f_dark = sys.argv[4]
    path_waybar = sys.argv[5]
    path_swaync = sys.argv[6]
    path_f_theme = sys.argv[7]
    waybar_ratio = float(sys.argv[8])
    
    raw_colors = sys.stdin.read().splitlines()
    
    # --- PROCESSING ---
    sorted_raw = sorted([hex_to_rgb(c) for c in raw_colors if c], key=get_lum)
    if not sorted_raw: sys.exit(1)
    
    colors = [desaturate(c, 0.7) for c in sorted_raw]
    if len(colors) < 16: colors = (colors * 16)[:16]
    
    idx_2nd_dark = 1
    idx_2nd_light = -2

    # --- FUZZEL GENERATION ---
    f_header = "[main]\nfont=SF Pro Display:size=12\nicons-enabled=no\nwidth=60\nlines=5\nhorizontal-pad=40\nvertical-pad=20\ninner-pad=10\n"
    
    # Light Theme
    l_bg = colors[idx_2nd_light]
    l_sel = colors[-3]
    l_text = ensure_contrast(l_bg, colors[2], target_ratio)
    l_match = ensure_contrast(l_bg, colors[0], target_ratio)
    l_sel_txt = ensure_contrast(l_sel, colors[0], target_ratio)
    
    with open(path_f_light, 'w') as f:
        f.write(f"# Light\n{f_header}[colors]\nbackground={to_hex(l_bg)}\ntext={to_hex(l_text)}\nmatch={to_hex(l_match)}\nselection={to_hex(l_sel)}\nselection-text={to_hex(l_sel_txt)}\nborder={to_hex(colors[2])}\n")

    # Dark Theme
    d_bg = colors[idx_2nd_dark]
    d_sel = colors[4]
    d_text = ensure_contrast(d_bg, colors[-3], target_ratio)
    d_match = ensure_contrast(d_bg, colors[-1], target_ratio)
    d_sel_txt = ensure_contrast(d_sel, colors[-1], target_ratio)
    
    with open(path_f_dark, 'w') as f:
        f.write(f"# Dark\n{f_header}[colors]\nbackground={to_hex(d_bg)}\ntext={to_hex(d_text)}\nmatch={to_hex(d_match)}\nselection={to_hex(d_sel)}\nselection-text={to_hex(d_sel_txt)}\nborder={to_hex(colors[-3])}\n")

    # Update Active Theme
    if is_light_bg:
        shutil.copyfile(path_f_light, path_f_theme)
    else:
        shutil.copyfile(path_f_dark, path_f_theme)

    # --- CSS GENERATION (Waybar / SwayNC) ---
    if is_light_bg:
        active_bg = l_bg
        raw_accent = l_sel
        raw_urgent = colors[0]
    else:
        active_bg = d_bg
        raw_accent = d_sel
        raw_urgent = colors[-1]

    # Enforce High Contrast (Ratio 7.0) for Waybar items
    active_acc = ensure_contrast(active_bg, raw_accent, waybar_ratio)
    active_urg = ensure_contrast(active_bg, raw_urgent, waybar_ratio)

    active_fg = (255, 255, 255)

    css_lines = []
    css_lines.append(f"@define-color background #{to_hex(active_bg, '')};")
    css_lines.append(f"@define-color foreground #{to_hex(active_fg, '')};")
    css_lines.append(f"@define-color accent #{to_hex(active_acc, '')};")
    css_lines.append(f"@define-color urgent #{to_hex(active_urg, '')};")
    css_lines.append(f"@define-color cursor #{to_hex(active_acc, '')};")
    
    for i in range(16):
        css_lines.append(f"@define-color color{i} #{to_hex(colors[i], '')};")

    css_content = "\n".join(css_lines)
    with open(path_waybar, 'w') as f: f.write(css_content)
    with open(path_swaync, 'w') as f: f.write(css_content)

except Exception as e:
    sys.exit(1)
EOF

# --- 6. EXECUTE ---
echo "--- Generating Colors ---"
PALETTE_RAW=$(magick "$FULL_PATH" -resize 100x100 -quantize RGB -colors 16 -unique-colors txt:- | grep -o '#[A-Fa-f0-9]\{6\}')
IS_LIGHT_BG=$(magick "$FULL_PATH" -colorspace gray -format "%[fx:mean>0.5?1:0]" info:)

python3 "$GEN_SCRIPT" "$CONTRAST_RATIO" "$IS_LIGHT_BG" "$FUZZEL_LIGHT" "$FUZZEL_DARK" "$WAYBAR_CACHE_FILE" "$SWAYNC_CACHE_FILE" "$FUZZEL_THEME" "$WAYBAR_CONTRAST_RATIO" <<< "$PALETTE_RAW"

rm "$GEN_SCRIPT"

# --- 7. RELOAD EVERYTHING ---
if [ -f "$WAYBAR_CACHE_FILE" ]; then
    echo "Success!"
    killall fuzzel 2>/dev/null
    pkill -SIGUSR2 waybar
    swaync-client -rs
    echo "Reloaded."
else
    echo "CRITICAL ERROR: Failed to generate color files."
    exit 1
fi
